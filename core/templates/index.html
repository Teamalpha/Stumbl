{% extends 'base.html' %}
{% load staticfiles %}

{% block title %}
  {{ block.super }}
{% endblock title %}


{% block content %}
<img src="{% static 'images/arrow.svg' %}" id="arrow" class="absolute" alt="Compass arrow">
<div id="vue-instance">

  <div id='test'></div>
  <div id='alpha'></div>
  <div id='beta'></div>
  <div id='gamma'></div>
  <div id='compass'></div>
  <div id='distance'></div>
  <div id='location'></div>
  <div id='location2'></div>

  <button class="button is-info open-pl-modal">Playlists</button>
  <button @click="activePlaylistsModal()" class="button is-info ">Active Playlists</button>

  <div class="control">
    <input id="pac-input" class="controls top-layer input" type="text" placeholder="choose destination">
  </div>


  <div class="empty-space"></div>
  <div id="map"></div>
  <div class="empty-space"></div>
  <div id='c-heading'></div>
  <div id='c-bearing'></div>
  <div id='c-finalheading'></div>
  <div id='c-distance'></div>


  {% comment %} Choose city modal {% endcomment %}
  <div id="choose-city-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Search cities
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter	" id="exit-choose-city-modal" aria-label="close">Back</button>
      </header>
      <section id="city-list" class="modal-card-body">
        <div v-for="city in cities">
          <button @click="getCityPlaylists(city)" class="button is-success is-fullwidth">${city}</button>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button @click="newPlaylistModal()" class="button is-primary">New Playlist</button>
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} City playlists modal {% endcomment %}
  <div id="city-playlists-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Search playlists
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter	" id="exit-city-playlists-modal" aria-label="close">Back</button>
      </header>
      <section id="city-playlists" class="modal-card-body">
        <div v-for="playlist in cityPlaylists">
          <button @click="getPlaylist(playlist)" class="button is-success is-fullwidth">${playlist.title}</button>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button @click="newPlaylistModal()" class="button is-primary">New Playlist</button>
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} Playlist detail modal {% endcomment %}
  <div id="playlist-detail-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        ${currentPlaylist.title}
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter	" id="exit-playlist-detail-modal" aria-label="close">Back</button>
      </header>
      <section id="playlist-detail" class="modal-card-body">

        <article v-for="destination in currentPlaylist.destinations" class="message is-success is-small">
          <div class="message-header">
            <p>${destination.name}</p>
          </div>
          <div class="message-body has-background-grey-lighter">${destination.description}</div>
        </article>

      </section>
      <footer class="modal-card-foot">
        <button @click="applyGems()" class="button is-primary apply-playlist">Select playlist</button>
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
        {% if user.is_authenticated %}
        <div v-if="userOwns()">
          <button @click="editPlaylist()" class="button is-warning">Edit</button>
          <button @click="confirmDeletePlaylist()" class="button is-danger">Delete</button>
        </div>
        {% endif %}
      </footer>
    </div>
  </div>

  {% comment %} Create Playlist modal {% endcomment %}
  <div id="create-playlist-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Create new playlist
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter" id="exit-create-playlist-modal" aria-label="close">Back</button>
      </header>
      <section id="create-playlist" class="modal-card-body">

        {% comment %} <article class="message is-success is-small">
          <div class="message-header">
            <p>${item.name}</p>
          </div>
          <div class="message-body">${item.description}</div>
        </article> {% endcomment %}

        <div class="field">
          <label class="label">Title</label>
          <div class="control">
            <input v-model="currentTitle" class="input" type="text" placeholder="Playlist name">
          </div>
        </div>

        <div class="field">
          <label class="label">City</label>
          <div class="control">
            <input v-model="currentCity" class="input is-success" type="text" placeholder="City" value="bulma">
          </div>
        </div>

        <div class="field">
          <label class="label">Description</label>
          <div class="control">
            <textarea v-model="currentDescription" id="current-place-description" class="textarea input is-success"
              type="text" placeholder="Description"></textarea>
          </div>
        </div>

        <label class="checkbox">
          <input id="accessible" type="checkbox" value="true">
          Accessible
        </label>

      </section>

      <footer class="modal-card-foot">
        <button @click="addPlaylist()" class="button is-link">Create Playlist</button>
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} Edit Playlist modal {% endcomment %}
  <div id="edit-playlist-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Customize *${currentPlaylist.title}*</p>
        <button class="button has-background-grey-lighter	" id="exit-edit-playlist-modal" aria-label="close">Back</button>
      </header>
      <section id="create-playlist" class="modal-card-body">

        <article v-for="destination in currentPlaylist.destinations" class="message is-success is-small">
          <div class="message-header">
            <p>${destination.name}</p>
          </div>
          <div class="message-body columns">
            <div class="column">${destination.description}</div>
            <div v-if="userOwns()" class="column is-one-quarter"> <button @click="deleteDestination(destination.pk)"
                class="button is-danger cancel">Remove</button>
            </div>
          </div>
        </article>

        <label class="label">Add a gem</label>
        <div class="control">
          <input id="modal-autocomplete" class="controls input" type="text" placeholder="choose destination">
        </div>

        <div class="field">
          <label class="label">Name</label>
          <div class="control">
            <input v-model="currentDestination.name" id="current-place-name" class="input" type="text" placeholder="Place name">
          </div>
        </div>

        <div class="field">
          <label class="label">Address</label>
          <div class="control">
            <input v-model="currentDestination.formatted_address" id="current-place-address" class="input is-success"
              type="text" placeholder="Address" readonly>
          </div>
        </div>

        <div class="field">
          <label class="label">What makes this place a hidden gem?</label>
          <div class="control">
            <textarea v-model="destinationDescription" id="current-place-description" class="textarea input is-success"
              type="text" placeholder="Description"></textarea>
          </div>
        </div>

      </section>

      <footer class="modal-card-foot">
        <button @click="addDestination()" class="button is-link">Add Gem</button>
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} Duplicate Playlist Modal {% endcomment %}
  <div id="duplicate-playlist-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Duplicate Playlist!
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter	" id="exit-duplicate-playlist-modal" aria-label="close">Back</button>
      </header>
      <section id="city-playlists" class="modal-card-body">
        <p>You have already created a playlist with that name!</p>
      </section>
      <footer class="modal-card-foot">
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} Duplicate Destination modal {% endcomment %}
  <div id="duplicate-destination-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Duplicate Destination
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter	" id="exit-duplicate-destination-modal" aria-label="close">Back</button>
      </header>
      <section id="city-playlists" class="modal-card-body">
        <p>This playlist already has a destination with that name!</p>
      </section>
      <footer class="modal-card-foot">
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} Confirm delete playlist modal {% endcomment %}
  <div id="confirm-delete-playlist-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Confirm delete playlist
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter" id="exit-confirm-delete-playlist-modal" aria-label="close">Back</button>
      </header>
      <section class="modal-card-body">
        <p>Are you sure you want to delete this playlist?</p>
      </section>
      <footer class="modal-card-foot">
        <button @click="deletePlaylist()" class="button is-warning">Delete Playlist</button>
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

  {% comment %} Active playlists modal {% endcomment %}
  <div id="active-playlists-modal" class="modal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        Active playlists
        <p class="modal-card-title"></p>
        <button class="button has-background-grey-lighter	" id="exit-active-playlists-modal" aria-label="close">Back</button>
      </header>
      <section class="modal-card-body">
        <div v-for="playlist in activePlaylists" class="columns">
          <div class="column">
            <button @click="getPlaylist(playlist)" class="button is-success is-fullwidth">${playlist.title}</button>
          </div>
          <div class="column is-one-quarter">
            <button @click="disablePlaylist(playlist)" class="button is-danger">Remove</button>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button @click="closeModals()" class="button is-danger cancel">Cancel</button>
      </footer>
    </div>
  </div>

</div> <!-- close vue instance div -->

<script>
  var map, infoWindow, destWindow, placeCoords, places, autocomplete, lastAutocomplete;

  function initAutocomplete() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 35.993, lng: -78.905 },
      zoom: 18,
      disableDefaultUI: true,
      styles: [
        { elementType: 'geometry', stylers: [{ color: '#242f3e' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#242f3e' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#746855' }] },
        { featureType: 'administrative.locality', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] },
        { featureType: 'poi', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] },
        { featureType: 'poi.park', elementType: 'geometry', stylers: [{ color: '#263c3f' }] },
        { featureType: 'poi.park', elementType: 'labels.text.fill', stylers: [{ color: '#6b9a76' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#38414e' }] },
        { featureType: 'road', elementType: 'geometry.stroke', stylers: [{ color: '#212a37' }] },
        { featureType: 'road', elementType: 'labels.text.fill', stylers: [{ color: '#9ca5b3' }] },
        { featureType: 'road.highway', elementType: 'geometry', stylers: [{ color: '#746855' }] },
        { featureType: 'road.highway', elementType: 'geometry.stroke', stylers: [{ color: '#1f2835' }] },
        { featureType: 'road.highway', elementType: 'labels.text.fill', stylers: [{ color: '#f3d19c' }] },
        { featureType: 'transit', elementType: 'geometry', stylers: [{ color: '#2f3948' }] },
        { featureType: 'transit.station', elementType: 'labels.text.fill', stylers: [{ color: '#d59563' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#17263c' }] },
        { featureType: 'water', elementType: 'labels.text.fill', stylers: [{ color: '#515c6d' }] },
        { featureType: 'water', elementType: 'labels.text.stroke', stylers: [{ color: '#17263c' }] }
      ]
    });

    function loadDefaultPlaylist() {
      $.get('/api/playlists/1/').then(function (playlist) {
        for (let destination of playlist.destinations) {
          let coords = { "lat": +destination.lat, "lng": +destination.lng };
          var marker = new google.maps.Marker({
            position: coords,
            map: map,
            icon: "https://img.icons8.com/color/48/000000/crystal.png",
          });
          let contentString = `${destination.name} - ${destination.description}`;
          google.maps.event.addListener(marker, 'click', function () {
            var infowindow = new google.maps.InfoWindow({
              content: contentString
            });
            infowindow.open(map, this);
          });
        }
      });
    }

    loadDefaultPlaylist();

    var input = document.getElementById('pac-input');
    var searchBox = new google.maps.places.SearchBox(input);
    var modalAutocomplete = document.getElementById('modal-autocomplete')

    // Bias the SearchBox results towards current map's viewport.
    map.addListener('bounds_changed', function () {
      searchBox.setBounds(map.getBounds());
    });

    // Listen for the event fired when the user selects a prediction and retrieve
    // more details for that place.
    searchBox.addListener('places_changed', function () {
      var places = searchBox.getPlaces();
      arrow.style.display = 'inline-block';
      let place_lat = places[0].geometry.location.lat()
      let place_lng = places[0].geometry.location.lng()
      placeCoords = { lat: place_lat, lng: place_lng }
      let place_address = places[0].formatted_address
      let place_name = places[0].name
      destWindow = new google.maps.InfoWindow
      destWindow.setPosition({ lat: place_lat, lng: place_lng })
      destWindow.setContent(place_name)
      destWindow.open(map)
      map.setCenter({ lat: place_lat, lng: place_lng });

      let destination = ({ lat: place_lat, lng: place_lng });
      var marker = new google.maps.Marker({
        position: destination,
        map: map,
        icon: "https://img.icons8.com/metro/50/launched-rocket.png",
        animation: google.maps.Animation.BOUNCE,
      });
    });


    autocomplete = new google.maps.places.Autocomplete(modalAutocomplete);
    autocomplete.bindTo('bounds', map);

    autocomplete.addListener('place_changed', function () {
      vm.currentDestination = autocomplete.getPlace();
    })

    function recenter() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          var pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          }
          if (stayCentered) {
            map.setCenter(pos);
          }
        }), function () {
          handleLocationError(true, infoWindow, map.getCenter());
        };
      }
    }

    setInterval(recenter, 1000);

    // listen for when user drags map and disable recentering
    map.addListener('dragstart', function () {
      stayCentered = false
    });

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }
  }
</script>
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&libraries=places&callback=initAutocomplete"
  defer></script>
{% endblock content %}